use org.openflexo.ta.opcua.OPCServerModelSlot as OPCUA;

import org.openflexo.ta.opcua.model.OPCServer;
import org.openflexo.ta.opcua.model.OPCNamespace;
import org.openflexo.ta.opcua.model.nodes.OPCNode;

@URI("http://openflexo.org/opc-ua-test/MinimalServer.fml")
@Author("sylvainguerin")
public model MinimalServer {
	OPCServer opcServer with OPCServerModelSlot();

   create(Resource<OPCServer> connexion) {
      opcServer = parameters.connexion.resourceData;
      log "c'est parti pour la synchro";
      this.synchronize();
   }

   public synchronize() {
	  log "calcul du MatchingSet";
      MatchingSet<Namespace> matchingSet = begin match Namespace from this;
      log "matchingSet=" + matchingSet;
      for (OPCNamespace ns : opcServer.namespaces) {
          log " >>> " + ns.uri;
          match Namespace 
               in matchingSet from this 
               where (opcNamespace=ns) create::init(ns);
      }
      end match Namespace in matchingSet delete::performDelete();

   }

   public debug() {
      log "Found namespaces : " + opcServer.namespaces;
      for (OPCNamespace ns : opcServer.namespaces) {
          log " OPCNamespace " + ns.uri;
          for (OPCNode node : ns.getAllNodes()) {
            log "   > " + node.qualifiedName;
          }
      }
   }

   concept Namespace {
	   OPCNamespace opcNamespace with OPCNamespaceRole(container=opcServer);

      create::init(OPCNamespace ns) {
         opcNamespace = parameters.ns;
      }

      delete::performDelete() {
         opcNamespace = null;
      }

   }

 }
